import{d as xe,r as S,V as y,W as Ne,X as $e,c as V,e as f,w as s,h as r,i as t,l as Be,j as a,Y as ne,f as c,Q as F,Z,B as Ae,t as m,C as n,F as N,$ as De,x as Fe,a0 as Ue,n as $,a1 as je,a2 as Je,a3 as U,a4 as oe,a5 as Oe,a6 as Re,A as Te,a7 as _e,y as ze,z as Le,m as g,g as se,p as re,_ as G,a8 as ie,a9 as Y,aa as B,ab as ue,ac as Pe,ad as We,ae as de,af as qe,ag as me,ah as fe,ai as He,aj as Me}from"./index-ab2O0MvO.js";/* empty css                    */import{_ as Ye}from"./tryit.vue_vue_type_script_setup_true_lang-C9EVc9Y2.js";const Qe={key:0,style:{color:"red"}},Xe={key:1},Ze={key:1},Ge={class:"draw-view"},at=xe({__name:"schema",setup(Ie){const I=S([]),z={[y.Namespace]:1,[y.Scalar]:2,[y.Enum]:3,[y.Struct]:4,[y.Array]:5,[y.Func]:6,[y.Json]:7,[y.Event]:8,[y.Workflow]:9,[y.Policy]:10},ye=[y.Struct,y.Array],d=Ne({namespace:"",type:null,keyword:""});if(localStorage.schema_man_search)try{const o=JSON.parse(localStorage.schema_man_search);o&&typeof o=="object"&&(d.namespace=o.namespace||"",d.type=o.type||null,d.keyword=o.keyword||"")}catch(o){}const pe=()=>{re(d.keyword)?re(d.type)?d.namespace="":d.type=null:d.keyword=""},ve=()=>{const o=d.namespace.split(".");d.namespace=o.slice(0,o.length-1).join(".")},we=o=>{d.namespace=o.name},L=async()=>{localStorage.schema_man_search=JSON.stringify(d);const o=await ie(d.namespace||"");if((o==null?void 0:o.type)===y.Namespace){let e=[...o.schemas||[]];e=e.filter(l=>((l.loadState||0)&U.Frontend)===0),d.type&&(e=e.filter(l=>l.type===d.type)),d.keyword&&(e=e.filter(l=>l.name.match(d.keyword)||l.display&&"".concat(l.display).match(d.keyword))),e.sort((l,p)=>z[l.type]<z[p.type]?-1:z[l.type]<z[p.type]?1:l.name<p.name?-1:1),I.value=e}};$e(d,L,{immediate:!0});const K=S(),C=S(!1),u=S(void 0),j=S(""),P=S(!1);let E=null;const ce=async()=>{localStorage.schema_new_namespace=d.namespace,u.value=new G({type:"system.schema.nodeschema"},{});const o=u.value.getField("type");o.rule.blackList=[y.Json,y.Event,y.Workflow],C.value=!0,E=u.value.subscribe(()=>{var e,l;j.value=n.value["frontend.view.new"]+" "+(n.value((e=u.value)==null?void 0:e.data.display)||((l=u.value)==null?void 0:l.data.name)||"")},!0)},x=S(null),ee=async(o,e)=>{var p,v;x.value=o;const l=await ie(o.name);u.value=new G({type:"system.schema.nodeschema",readonly:e},Y(l)),C.value=!0,e?j.value=n.value["frontend.view.view"]+" "+(n.value((p=u.value)==null?void 0:p.data.display)||((v=u.value)==null?void 0:v.data.name)||""):E=u.value.subscribe(()=>{var w,b;j.value=n.value["frontend.view.edit"]+" "+(n.value((w=u.value)==null?void 0:w.data.display)||((b=u.value)==null?void 0:b.data.name)||"")},!0)},ke=async o=>{if(!oe(o.name)){B.error(n.value["frontend.view.cantdelschema"]);return}if((o.loadState||0)&U.Server){const e=ue();if(e)try{if(!await e.deleteSchema(o.name)){B.error(n.value["frontend.view.error"]);return}}catch(l){if(l&&l.status===403){B.error(n.value["frontend.view.nopermission"]);return}B.error(n.value["frontend.view.error"]),console.error(l);return}}return Pe(o.name),We(o.name),L()},ge=async()=>{var p,v,w;if(!await((p=K.value)==null?void 0:p.validate())||!((v=u.value)!=null&&v.valid)||!((w=u.value)!=null&&w.valid))return;const e=de(Y(qe(u.value.data))),l=me(e.name);if(!l||(l.loadState||0)&U.Server){const b=ue();if(b)try{if(!await b.saveSchema(e)){B.error(n.value["frontend.view.error"]);return}e.loadState=(e.loadState||0)|U.Server}catch(D){if(D&&D.status===403){B.error(n.value["frontend.view.nopermission"]);return}B.error(n.value["frontend.view.error"]),console.error(D);return}}return fe([e],e.loadState),He(e),Q(),C.value=!1,L()},Q=()=>{var o;E&&E(),(o=u.value)==null||o.dispose(),u.value=void 0,E=null,x.value=null},W=S(!1),te=S(""),be=()=>{var o;te.value=(o=u.value)==null?void 0:o.rawData.name,W.value=!0},Se=async()=>{var l;const o=Y((l=u.value)==null?void 0:l.rawData);if(!o)return;Q(),C.value=!1,await new Promise(p=>setTimeout(p,200));const e="".concat(o.name,"_copy");o.name="",localStorage.schema_new_namespace=d.namespace,u.value=new G({type:"system.schema.nodeschema"},Y(o)),u.value.getField("name").data=e,E&&E(),E=u.value.subscribe(()=>{var p,v;j.value=n.value["frontend.view.new"]+" "+(n.value((p=u.value)==null?void 0:p.data.display)||((v=u.value)==null?void 0:v.data.name)||"")},!0),C.value=!0},J=S(!1);let A=[];const Ce=()=>{A=[],J.value=!0},he=o=>{A=o.map(e=>e.name)},Ve=()=>{if(!A.length)return;const o=A.length>1?"system.schema.json":"".concat(A[0],".json"),e=JSON.stringify(A.map(me).map(w=>de(w)).filter(w=>{var b;return w.type!==y.Namespace||((b=w.schemas)==null?void 0:b.length)}),null,2),l=new Blob([e],{type:"application/octet-stream"}),p=URL.createObjectURL(l),v=document.createElement("a");v.href=p,v.download=o,document.body.appendChild(v),v.click(),document.body.removeChild(v),J.value=!1},Ee=o=>(o.text().then(e=>{const l=JSON.parse(e);if(Array.isArray(l))return fe(l,U.Custom),Me(),L()}),!1);return(o,e)=>{const l=Ae,p=De,v=Be,w=je,b=Oe,D=Ue,q=Fe,H=Te,M=Le,X=ze;return f(),V(M,{class:"main"},{default:s(()=>{var ae,le;return[r(v,{style:{height:"fit-content",width:"100%"}},{default:s(()=>[r(a(ne),{model:d,style:{display:"flex"},"hide-required-asterisk":"",inline:""},{default:s(()=>[r(a(F),{modelValue:d.namespace,"onUpdate:modelValue":e[0]||(e[0]=i=>d.namespace=i),"in-form":"",config:{type:"system.schema.namespace",display:a(Z)("system.schema.namespace")}},null,8,["modelValue","config"]),e[14]||(e[14]=t()),r(a(F),{modelValue:d.type,"onUpdate:modelValue":e[1]||(e[1]=i=>d.type=i),"in-form":"",config:{type:"system.schema.schematype",display:a(Z)("system.schema.schematype")}},null,8,["modelValue","config"]),e[15]||(e[15]=t()),r(a(F),{modelValue:d.keyword,"onUpdate:modelValue":e[2]||(e[2]=i=>d.keyword=i),"in-form":"",config:{type:"system.string",display:a(Z)("frontend.view.keyword")}},null,8,["modelValue","config"]),e[16]||(e[16]=t()),r(l,{type:"info",onClick:pe},{default:s(()=>[t(m(a(n)["frontend.view.reset"]),1)]),_:1}),e[17]||(e[17]=t()),r(l,{type:"primary",onClick:ce},{default:s(()=>[t(m(a(n)["frontend.view.new"]),1)]),_:1}),e[18]||(e[18]=t()),J.value?(f(),c(N,{key:1},[r(l,{type:"success",onClick:Ve},{default:s(()=>[t(m(a(n)["frontend.view.confirm"]),1)]),_:1}),e[13]||(e[13]=t()),r(l,{type:"info",onClick:e[3]||(e[3]=i=>J.value=!1)},{default:s(()=>[t(m(a(n)["frontend.view.cancel"]),1)]),_:1})],64)):(f(),c(N,{key:0},[r(l,{type:"success",onClick:Ce},{default:s(()=>[t(m(a(n)["frontend.view.download"]),1)]),_:1}),e[12]||(e[12]=t()),r(p,{style:{"padding-left":"1rem"},"before-upload":Ee,limit:1,"show-file-list":!1},{default:s(()=>[r(l,{type:"success"},{default:s(()=>[t(m(a(n)["frontend.view.upload"]),1)]),_:1})]),_:1})],64))]),_:1},8,["model"])]),_:1}),e[48]||(e[48]=t()),r(q,null,{default:s(()=>[r(D,{data:I.value,style:{width:"100%",height:"70vh"},border:!0,"header-align":"left","header-cell-style":{background:"#eee"},onSelectionChange:he},{default:s(()=>[J.value?(f(),V(w,{key:0,type:"selection",width:"55"})):$("",!0),e[22]||(e[22]=t()),r(w,{align:"left",prop:"name",label:a(n)["frontend.view.name"],"min-width":"120"},{default:s(i=>[i.row.status&&i.row.status!=a(Je).Ready?(f(),c("span",Qe,m(i.row.name),1)):(f(),c("span",Xe,m(i.row.name),1))]),_:1},8,["label"]),e[23]||(e[23]=t()),r(w,{align:"center",prop:"type",label:a(n)["frontend.view.type"],width:"150"},{default:s(i=>[t(m(a(n)["system.schema.schematype."+i.row.type]),1)]),_:1},8,["label"]),e[24]||(e[24]=t()),r(w,{align:"left",prop:"display",label:a(n)["frontend.view.display"],"min-width":"150"},{default:s(i=>{var k;return[t(m(a(n)((k=i.row.display)!=null&&k.key?i.row.display:i.row.name)),1)]}),_:1},8,["label"]),e[25]||(e[25]=t()),r(w,{align:"left","header-align":"center",label:a(n)["frontend.view.oper"],width:"280"},{header:s(()=>[d.namespace?(f(),c("a",{key:0,href:"javascript:void(0)",onClick:ve,style:{"text-decoration":"underline",color:"lightseagreen"}},m(a(n)["frontend.view.return"]),1)):(f(),c("span",Ze,m(a(n)["frontend.view.oper"]),1))]),default:s(i=>{var k;return[i.row.type===a(y).Namespace?(f(),V(l,{key:0,type:i.row.hasSchemas||(k=i.row.schemas)!=null&&k.length?"success":"info",onClick:h=>we(i.row)},{default:s(()=>[t(m(a(n)["frontend.view.down"]),1)]),_:1},8,["type","onClick"])):(f(),V(l,{key:1,type:"success",onClick:h=>ee(i.row,!0)},{default:s(()=>[t(m(a(n)["frontend.view.view"]),1)]),_:1},8,["onClick"])),e[19]||(e[19]=t()),!((i.row.loadState||0)&a(U).System)||i.row.type===a(y).Namespace?(f(),V(l,{key:2,type:"warning",onClick:h=>ee(i.row,!1)},{default:s(()=>[t(m(a(n)["frontend.view.edit"]),1)]),_:1},8,["onClick"])):$("",!0),e[20]||(e[20]=t()),a(oe)(i.row.name)?(f(),V(b,{key:3,title:a(n)["frontend.view.confirmdelete"],"confirm-button-text":a(n).YES,"cancel-button-text":a(n).NO,icon:a(Re),onConfirm:h=>ke(i.row)},{reference:s(()=>[r(l,{type:"danger"},{default:s(()=>[t(m(a(n)["frontend.view.delete"]),1)]),_:1})]),_:1},8,["title","confirm-button-text","cancel-button-text","icon","onConfirm"])):$("",!0)]}),_:1},8,["label"])]),_:1},8,["data"])]),_:1}),e[49]||(e[49]=t()),r(H,null,{default:s(()=>[r(l,{type:"danger",onClick:a(_e),style:{position:"absolute",right:"3rem"}},{default:s(()=>[t(m(a(n)["frontend.view.clearcustomschemas"]),1)]),_:1},8,["onClick"])]),_:1}),e[50]||(e[50]=t()),r(X,{modelValue:C.value,"onUpdate:modelValue":e[7]||(e[7]=i=>C.value=i),title:j.value,direction:"rtl",size:"100%","append-to-body":"",onClosed:Q},{default:s(()=>[r(M,{class:"main",style:{height:"80vh"}},{default:s(()=>[r(q,null,{default:s(()=>[u.value?(f(),V(a(ne),{key:0,ref_key:"editorRef",ref:K,model:u.value.rawData,"label-width":"160","label-position":"left",style:{width:"100%",height:"90%"}},{default:s(()=>[g("div",Ge,[r(a(F),{node:u.value,"in-form":"expandall","plain-text":"left"},null,8,["node"])])]),_:1},8,["model"])):$("",!0)]),_:1}),e[32]||(e[32]=t()),r(H,null,{default:s(()=>{var i,k,h,O,R;return[e[30]||(e[30]=g("br",null,null,-1)),e[31]||(e[31]=t()),(i=u.value)!=null&&i.readonly?(f(),c(N,{key:0},[ye.includes(u.value.rawData.type)?(f(),V(l,{key:0,type:"primary",onClick:be},{default:s(()=>[t(m(a(n)["frontend.view.tryit"]),1)]),_:1})):$("",!0),e[26]||(e[26]=t()),r(l,{onClick:e[4]||(e[4]=T=>C.value=!1)},{default:s(()=>[t(m(a(n)["frontend.view.close"]),1)]),_:1}),e[27]||(e[27]=t()),(h=(k=x.value)==null?void 0:k.usedBy)!=null&&h.length||(R=(O=x.value)==null?void 0:O.usedByApp)!=null&&R.length?(f(),V(l,{key:1,onClick:e[5]||(e[5]=T=>P.value=!0),style:{float:"right"},type:"info"},{default:s(()=>[t(m(a(n)["frontend.view.viewref"]),1)]),_:1})):$("",!0),e[28]||(e[28]=t()),r(l,{type:"warning",onClick:Se},{default:s(()=>[t(m(a(n)["frontend.view.copyschema"]),1)]),_:1})],64)):(f(),c(N,{key:1},[r(l,{type:"primary",onClick:ge},{default:s(()=>[t(m(a(n)["frontend.view.save"]),1)]),_:1}),e[29]||(e[29]=t()),r(l,{onClick:e[6]||(e[6]=T=>C.value=!1)},{default:s(()=>[t(m(a(n)["frontend.view.cancel"]),1)]),_:1})],64))]}),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[51]||(e[51]=t()),r(X,{modelValue:W.value,"onUpdate:modelValue":e[9]||(e[9]=i=>W.value=i),title:a(n)["frontend.nav.tryit"]+" - "+(a(n)((ae=u.value)==null?void 0:ae.data.display)||((le=u.value)==null?void 0:le.data.name)),direction:"rtl",size:"100%","append-to-body":"","destroy-on-close":""},{default:s(()=>[r(M,{class:"main",style:{height:"80vh"}},{default:s(()=>[r(q,null,{default:s(()=>[r(Ye,{type:te.value},null,8,["type"])]),_:1}),e[35]||(e[35]=t()),r(H,null,{default:s(()=>[e[33]||(e[33]=g("br",null,null,-1)),e[34]||(e[34]=t()),r(l,{onClick:e[8]||(e[8]=i=>W.value=!1)},{default:s(()=>[t(m(a(n)["frontend.view.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[52]||(e[52]=t()),r(X,{modelValue:P.value,"onUpdate:modelValue":e[11]||(e[11]=i=>P.value=i),title:a(n)["frontend.view.viewref"],direction:"rtl",size:"40%","append-to-body":""},{default:s(()=>[r(M,{class:"main",style:{height:"80vh"}},{default:s(()=>[r(q,null,{default:s(()=>{var i,k,h,O,R,T;return[(k=(i=x.value)==null?void 0:i.usedBy)!=null&&k.length?(f(),c(N,{key:0},[g("h3",null,m(a(n)["system.schema.schematype"]),1),e[36]||(e[36]=t()),e[37]||(e[37]=g("hr",null,null,-1)),e[38]||(e[38]=t()),g("ul",null,[(f(!0),c(N,null,se((h=x.value)==null?void 0:h.usedBy,_=>(f(),c("li",{key:_},[r(a(F),{config:{type:"system.schema.anytype",readonly:!0},value:_,"plain-text":"left"},null,8,["value"])]))),128))]),e[39]||(e[39]=t()),e[40]||(e[40]=g("br",null,null,-1))],64)):$("",!0),e[44]||(e[44]=t()),(R=(O=x.value)==null?void 0:O.usedByApp)!=null&&R.length?(f(),c(N,{key:1},[g("h3",null,m(a(n)["frontend.apptarget.app"]),1),e[41]||(e[41]=t()),e[42]||(e[42]=g("hr",null,null,-1)),e[43]||(e[43]=t()),g("ul",null,[(f(!0),c(N,null,se((T=x.value)==null?void 0:T.usedByApp,_=>(f(),c("li",{key:_},[r(a(F),{config:{type:"system.schema.app",readonly:!0},value:_,"plain-text":"left"},null,8,["value"])]))),128))])],64)):$("",!0)]}),_:1}),e[47]||(e[47]=t()),r(H,null,{default:s(()=>[e[45]||(e[45]=g("br",null,null,-1)),e[46]||(e[46]=t()),r(l,{onClick:e[10]||(e[10]=i=>P.value=!1)},{default:s(()=>[t(m(a(n)["frontend.view.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])]}),_:1})}}});export{at as default};

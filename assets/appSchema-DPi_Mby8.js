import{d as _e,r as g,M as je,N as Oe,c as k,e as c,w as s,h as i,i as l,m as Re,j as t,O as Z,f as U,Q as J,R as pe,S as De,t as d,k as a,F as q,V as Te,x as Be,W as Je,n as h,X as ze,$ as Ie,a0 as fe,a1 as We,ah as He,a3 as Le,y as Me,p as E,T as Ye,a4 as G,ai as _,a6 as K,Y as A,a8 as z,a7 as I,aj as Pe,ak as qe,ac as ee,al as me,am as ve,an as Q,ao as Ge,ap as Ke}from"./index-CP9KRlhr.js";/* empty css                    */import{_ as Qe}from"./tryapp.vue_vue_type_script_setup_true_lang-CssRwFRg.js";/* empty css                */const Xe={key:1},Ze={class:"draw-view"},el={class:"draw-view"},ol=_e({__name:"appSchema",setup(ll){const le=g([]),y=je({app:"",keyword:""});if(localStorage.schema_man_appsearch)try{const o=JSON.parse(localStorage.schema_man_appsearch);o&&typeof o=="object"&&(y.app=o.app||"",y.keyword=o.keyword||"")}catch(o){}const ye=()=>{Ye(y.keyword)?y.app="":y.keyword=""},ce=()=>{const o=y.app.split(".");y.app=o.slice(0,o.length-1).join(".")},ge=o=>{y.app=o.name},j=async()=>{localStorage.schema_man_appsearch=JSON.stringify(y);const o=await _(y.app||"");le.value=o!=null&&o.apps?[...o.apps]:[]};Oe(y,j,{immediate:!0});const ae=g(),S=g(!1),m=g(void 0),W=g("");let O=null;const we=async()=>{localStorage.schema_new_app=y.app,m.value=new G({type:"schema.app.app"},{}),S.value=!0,O=m.value.subscribe(()=>{var o,e;W.value=a.value["schema.designer.new"]+" "+(a.value((o=m.value)==null?void 0:o.data.display)||((e=m.value)==null?void 0:e.data.name)||"")},!0)},te=async(o,e)=>{var f,u;localStorage.schema_curr_app=o.name;const n=await _(o.name);m.value=new G({type:"schema.app.app",readonly:e},K(n)),S.value=!0,e?W.value=a.value["schema.designer.view"]+" "+(a.value((f=m.value)==null?void 0:f.data.display)||((u=m.value)==null?void 0:u.data.name)||""):O=m.value.subscribe(()=>{var p,b;W.value=a.value["schema.designer.edit"]+" "+(a.value((p=m.value)==null?void 0:p.data.display)||((b=m.value)==null?void 0:b.data.name)||"")},!0)},ke=o=>{if((o.loadState||0)&A.Server){const e=z();if(e&&!e.deleteAppSchema(o.name)){I.error(a.value["schema.designer.cantdelapp"]);return}}return Pe(o.name),qe(o.name),j()},be=async()=>{var f,u,p;if(!await((f=ae.value)==null?void 0:f.validate())||!((u=m.value)!=null&&u.valid)||!((p=m.value)!=null&&p.valid))return;const e=K(ee(m.value.data)),n=me(e.name);if(!n||(n.loadState||0)&A.Server){const b=z();if(b){if(!await b.saveAppSchema(e)){I.error(a.value["schema.designer.error"]);return}e.loadState=(e.loadState||0)|A.Server}}return ve([e],e.loadState),Q(e),ne(),S.value=!1,j()},ne=()=>{var o;O&&O(),(o=m.value)==null||o.dispose(),m.value=void 0,O=null},H=g(!1),F=g([]),X=g("");let x=null;const he=async o=>{x=o.name,localStorage.schema_curr_app=x;const e=await _(o.name);X.value=a.value(e==null?void 0:e.display)||(e==null?void 0:e.name)||"",F.value=e!=null&&e.fields?[...e.fields]:[],H.value=!0},Ce=o=>{const{row:e}=o;return e.disable?"disable-row":e.sourceApp?"ref-row":e.func?"push-row":e.frontend?"frontend-row":""},se=g(),V=g(!1),v=g(void 0),L=g("");let R=null;const Se=async()=>{v.value=new G({type:"schema.app.field"},{}),V.value=!0,R=v.value.subscribe(()=>{var o,e;L.value=a.value["schema.designer.new"]+" "+(a.value((o=v.value)==null?void 0:o.data.display)||((e=v.value)==null?void 0:e.data.name)||"")},!0)},oe=async(o,e)=>{var n,f;v.value=new G({type:"schema.app.field",readonly:e},K(ee(o))),V.value=!0,e?L.value=a.value["schema.designer.view"]+" "+(a.value((n=v.value)==null?void 0:n.data.display)||((f=v.value)==null?void 0:f.data.name)||""):R=v.value.subscribe(()=>{var u,p;L.value=a.value["schema.designer.edit"]+" "+(a.value((u=v.value)==null?void 0:u.data.display)||((p=v.value)==null?void 0:p.data.name)||"")},!0)},xe=async o=>{const e=await _(x);if(!(e!=null&&e.fields))return;if((e.loadState||0)&A.Server){const f=z();if(f&&!f.deleteAppFieldSchema(e.name,o.name)){I.error(a.value["schema.designer.error"]);return}}const n=e.fields.findIndex(f=>f.name===o.name);n>=0&&(e.fields.splice(n,1),Q(e),F.value=e!=null&&e.fields?[...e.fields]:[])},Ve=async o=>{const e=await _(x);if(!(e!=null&&e.fields))return;const n=e.fields.findIndex(u=>u.name===o.name);if(n<=0)return;const f=e.fields[n-1];if((e.loadState||0)&A.Server){const u=z();if(u&&!u.swapAppFieldSchema(e.name,o.name,f.name)){I.error(a.value["schema.designer.error"]);return}}e.fields[n-1]=e.fields[n],e.fields[n]=f,Q(e),F.value=e!=null&&e.fields?[...e.fields]:[]},Ee=async()=>{var u,p,b;if(!await((u=se.value)==null?void 0:u.validate())||!((p=v.value)!=null&&p.valid)||!((b=v.value)!=null&&b.valid))return;const e=K(ee(v.value.data)),n=await _(x);if(!n)return;if((n.loadState||0)&A.Server){const C=z();if(C&&!await C.saveAppFieldSchema(n.name,e)){I.error(a.value["schema.designer.error"]);return}}n.fields||(n.fields=[]);const f=n.fields.findIndex(C=>C.name===e.name);f>=0?n.fields[f]=e:n.fields.push(e),Q(n),F.value=n!=null&&n.fields?[...n.fields]:[],ie(),V.value=!1},ie=()=>{var o;R&&R(),(o=v.value)==null||o.dispose(),v.value=void 0,R=null,j()},M=g(!1),Ae=()=>{M.value=!0},D=g(!1);let $=[];const Fe=()=>{$=[],D.value=!0},$e=o=>{$=o.map(e=>e.name)},Ne=()=>{if(!$.length)return;const o=$.length>1?"appschema.json":"".concat($[0],".json"),e=JSON.stringify($.map(me).map(p=>Ge(p)),null,2),n=new Blob([e],{type:"application/octet-stream"}),f=URL.createObjectURL(n),u=document.createElement("a");u.href=f,u.download=o,document.body.appendChild(u),u.click(),document.body.removeChild(u),D.value=!1},Ue=o=>(o.text().then(e=>{const n=JSON.parse(e);if(Array.isArray(n))return ve(n,A.Custom),Ke(),j()}),!1);return(o,e)=>{const n=De,f=Te,u=Re,p=ze,b=Ie,C=Je,N=Be,T=We,B=Me,Y=Le;return c(),k(B,{class:"main"},{default:s(()=>[i(u,{style:{height:"fit-content",width:"100%"}},{default:s(()=>[i(t(Z),{model:y,style:{display:"flex"},"hide-required-asterisk":"",inline:""},{default:s(()=>[i(t(J),{modelValue:y.app,"onUpdate:modelValue":e[0]||(e[0]=r=>y.app=r),"in-form":"",config:{type:"schema.app.srcapp",display:t(pe)("schema.app.srcapp")}},null,8,["modelValue","config"]),e[15]||(e[15]=l()),i(t(J),{modelValue:y.keyword,"onUpdate:modelValue":e[1]||(e[1]=r=>y.keyword=r),"in-form":"",config:{type:"system.string",display:t(pe)("schema.designer.keyword")}},null,8,["modelValue","config"]),e[16]||(e[16]=l()),i(n,{type:"info",onClick:ye},{default:s(()=>[l(d(t(a)["schema.designer.reset"]),1)]),_:1}),e[17]||(e[17]=l()),i(n,{type:"primary",onClick:we},{default:s(()=>[l(d(t(a)["schema.designer.new"]),1)]),_:1}),e[18]||(e[18]=l()),D.value?(c(),U(q,{key:1},[i(n,{type:"success",onClick:Ne},{default:s(()=>[l(d(t(a)["schema.designer.confirm"]),1)]),_:1}),e[14]||(e[14]=l()),i(n,{type:"info",onClick:e[2]||(e[2]=r=>D.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.cancel"]),1)]),_:1})],64)):(c(),U(q,{key:0},[i(n,{type:"success",onClick:Fe},{default:s(()=>[l(d(t(a)["schema.designer.download"]),1)]),_:1}),e[13]||(e[13]=l()),i(f,{style:{"padding-left":"1rem"},"before-upload":Ue,limit:1,"show-file-list":!1},{default:s(()=>[i(n,{type:"success"},{default:s(()=>[l(d(t(a)["schema.designer.upload"]),1)]),_:1})]),_:1})],64))]),_:1},8,["model"])]),_:1}),e[51]||(e[51]=l()),i(N,null,{default:s(()=>[i(C,{data:le.value,style:{width:"100%",height:"70vh"},border:!0,"header-align":"left","header-cell-style":{background:"#eee"},onSelectionChange:$e},{default:s(()=>[D.value?(c(),k(p,{key:0,type:"selection",width:"55"})):h("",!0),e[24]||(e[24]=l()),i(p,{align:"left",prop:"name",label:t(a)["schema.designer.name"],"min-width":"120"},null,8,["label"]),e[25]||(e[25]=l()),i(p,{align:"left",prop:"display",label:t(a)["schema.designer.display"],"min-width":"150"},{default:s(r=>[l(d(t(a)(r.row.display)),1)]),_:1},8,["label"]),e[26]||(e[26]=l()),i(p,{align:"left",prop:"desc",label:t(a)["schema.designer.desc"],"min-width":"150"},{default:s(r=>[l(d(t(a)(r.row.desc)),1)]),_:1},8,["label"]),e[27]||(e[27]=l()),i(p,{align:"left","header-align":"center",label:t(a)["schema.designer.oper"],width:"440"},{header:s(()=>[y.app?(c(),U("a",{key:0,href:"javascript:void(0)",onClick:ce,style:{"text-decoration":"underline",color:"lightseagreen"}},d(t(a)["schema.designer.return"]),1)):(c(),U("span",Xe,d(t(a)["schema.designer.oper"]),1))]),default:s(r=>{var w,re,de,ue;return[i(n,{type:"info",onClick:P=>te(r.row,!0)},{default:s(()=>[l(d(t(a)["schema.designer.view"]),1)]),_:2},1032,["onClick"]),e[19]||(e[19]=l()),i(n,{type:"success",onClick:P=>te(r.row,!1)},{default:s(()=>[l(d(t(a)["schema.designer.edit"]),1)]),_:2},1032,["onClick"]),e[20]||(e[20]=l()),!r.row.hasFields&&!((w=r.row.fields)!=null&&w.length)?(c(),k(n,{key:0,type:"info",onClick:P=>ge(r.row)},{default:s(()=>[l(d(t(a)["schema.designer.down"]),1)]),_:2},1032,["onClick"])):h("",!0),e[21]||(e[21]=l()),!r.row.hasApps&&!((re=r.row.apps)!=null&&re.length)?(c(),k(n,{key:1,type:"primary",onClick:P=>he(r.row)},{default:s(()=>[l(d(t(a)["schema.designer.fields"]),1)]),_:2},1032,["onClick"])):h("",!0),e[22]||(e[22]=l()),!r.row.hasApps&&!((de=r.row.apps)!=null&&de.length)&&!r.row.hasFields&&!((ue=r.row.fields)!=null&&ue.length)?(c(),k(b,{key:2,title:t(a)["schema.designer.confirmdelete"],"confirm-button-text":t(a).YES,"cancel-button-text":t(a).NO,icon:t(fe),onConfirm:P=>ke(r.row)},{reference:s(()=>[i(n,{type:"danger"},{default:s(()=>[l(d(t(a)["schema.designer.delete"]),1)]),_:1})]),_:2},1032,["title","confirm-button-text","cancel-button-text","icon","onConfirm"])):h("",!0)]}),_:1},8,["label"])]),_:1},8,["data"])]),_:1}),e[52]||(e[52]=l()),i(T,null,{default:s(()=>[i(n,{type:"danger",onClick:t(He),style:{position:"absolute",right:"3rem"}},{default:s(()=>[l(d(t(a)["schema.designer.clearcustomapps"]),1)]),_:1},8,["onClick"])]),_:1}),e[53]||(e[53]=l()),i(Y,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=r=>S.value=r),title:W.value,direction:"rtl",size:"100%","append-to-body":"",onClosed:ne},{default:s(()=>[i(B,{class:"main",style:{height:"80vh"}},{default:s(()=>[i(N,null,{default:s(()=>[m.value?(c(),k(t(Z),{key:0,ref_key:"editorRef",ref:ae,model:m.value.rawData,"label-width":"160","label-position":"left",style:{width:"100%",height:"90%"}},{default:s(()=>[E("div",Ze,[i(t(J),{node:m.value,"in-form":"expandall","plain-text":"left"},null,8,["node"])])]),_:1},8,["model"])):h("",!0)]),_:1}),e[31]||(e[31]=l()),i(T,null,{default:s(()=>{var r;return[e[29]||(e[29]=E("br",null,null,-1)),e[30]||(e[30]=l()),(r=m.value)!=null&&r.readonly?(c(),k(n,{key:0,onClick:e[3]||(e[3]=w=>S.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.close"]),1)]),_:1})):(c(),U(q,{key:1},[i(n,{type:"primary",onClick:be},{default:s(()=>[l(d(t(a)["schema.designer.save"]),1)]),_:1}),e[28]||(e[28]=l()),i(n,{onClick:e[4]||(e[4]=w=>S.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.cancel"]),1)]),_:1})],64))]}),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[54]||(e[54]=l()),i(Y,{modelValue:H.value,"onUpdate:modelValue":e[7]||(e[7]=r=>H.value=r),title:X.value,direction:"rtl",size:"100%","append-to-body":""},{default:s(()=>[i(B,{class:"main",style:{height:"80vh"}},{default:s(()=>[i(N,null,{default:s(()=>[i(C,{data:F.value,"row-class-name":Ce,style:{width:"100%",height:"65vh"},border:!0,"header-align":"left","header-cell-style":{background:"#eee"}},{default:s(()=>[i(p,{align:"left",prop:"name",label:t(a)["schema.designer.name"],"min-width":"120"},null,8,["label"]),e[36]||(e[36]=l()),i(p,{align:"left",prop:"display",label:t(a)["schema.designer.display"],"min-width":"150"},{default:s(r=>[l(d(t(a)(r.row.display)),1)]),_:1},8,["label"]),e[37]||(e[37]=l()),i(p,{align:"left",prop:"type",label:t(a)["schema.designer.type"],"min-width":"120"},{default:s(r=>[i(t(J),{modelValue:r.row.type,"onUpdate:modelValue":w=>r.row.type=w,config:{type:"schema.valuetype",readonly:!0},"plain-text":"left"},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["label"]),e[38]||(e[38]=l()),i(p,{align:"left",prop:"desc",label:t(a)["schema.designer.desc"],"min-width":"150"},{default:s(r=>[l(d(t(a)(r.row.desc)),1)]),_:1},8,["label"]),e[39]||(e[39]=l()),i(p,{align:"left","header-align":"center",label:t(a)["schema.designer.oper"],width:"400"},{header:s(()=>[E("a",{href:"javascript:void(0)",onClick:Se,style:{"text-decoration":"underline",color:"lightseagreen"}},d(t(a)["schema.designer.new"]),1)]),default:s(r=>[i(n,{type:"info",onClick:w=>oe(r.row,!0)},{default:s(()=>[l(d(t(a)["schema.designer.view"]),1)]),_:2},1032,["onClick"]),e[32]||(e[32]=l()),i(n,{type:"success",onClick:w=>oe(r.row,!1)},{default:s(()=>[l(d(t(a)["schema.designer.edit"]),1)]),_:2},1032,["onClick"]),e[33]||(e[33]=l()),r.$index>0?(c(),k(n,{key:0,type:"warning",onClick:w=>Ve(r.row)},{default:s(()=>[l(d(t(a)["schema.designer.moveup"]),1)]),_:2},1032,["onClick"])):h("",!0),e[34]||(e[34]=l()),i(b,{title:t(a)["schema.designer.confirmdelete"],"confirm-button-text":t(a).YES,"cancel-button-text":t(a).NO,icon:t(fe),onConfirm:w=>xe(r.row)},{reference:s(()=>[i(n,{type:"danger"},{default:s(()=>[l(d(t(a)["schema.designer.delete"]),1)]),_:1})]),_:2},1032,["title","confirm-button-text","cancel-button-text","icon","onConfirm"])]),_:1},8,["label"])]),_:1},8,["data"])]),_:1}),e[43]||(e[43]=l()),i(T,null,{default:s(()=>[e[40]||(e[40]=E("br",null,null,-1)),e[41]||(e[41]=l()),F.value.length?(c(),k(n,{key:0,type:"primary",onClick:Ae},{default:s(()=>[l(d(t(a)["schema.designer.tryit"]),1)]),_:1})):h("",!0),e[42]||(e[42]=l()),i(n,{onClick:e[6]||(e[6]=r=>H.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[55]||(e[55]=l()),i(Y,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=r=>V.value=r),title:L.value,direction:"rtl",size:"100%","append-to-body":"",onClosed:ie},{default:s(()=>[i(B,{class:"main",style:{height:"80vh"}},{default:s(()=>[i(N,null,{default:s(()=>[v.value?(c(),k(t(Z),{key:0,ref_key:"fieldEditorRef",ref:se,model:v.value.rawData,"label-width":"160","label-position":"left",style:{width:"100%",height:"90%"}},{default:s(()=>[E("div",el,[i(t(J),{node:v.value,"in-form":"expandall","plain-text":"left"},null,8,["node"])])]),_:1},8,["model"])):h("",!0)]),_:1}),e[47]||(e[47]=l()),i(T,null,{default:s(()=>{var r;return[e[45]||(e[45]=E("br",null,null,-1)),e[46]||(e[46]=l()),(r=v.value)!=null&&r.readonly?(c(),k(n,{key:0,onClick:e[8]||(e[8]=w=>V.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.close"]),1)]),_:1})):(c(),U(q,{key:1},[i(n,{type:"primary",onClick:Ee},{default:s(()=>[l(d(t(a)["schema.designer.save"]),1)]),_:1}),e[44]||(e[44]=l()),i(n,{onClick:e[9]||(e[9]=w=>V.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.cancel"]),1)]),_:1})],64))]}),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[56]||(e[56]=l()),i(Y,{modelValue:M.value,"onUpdate:modelValue":e[12]||(e[12]=r=>M.value=r),title:t(a)["schema.nav.tryit"]+X.value,direction:"rtl",size:"100%","append-to-body":""},{default:s(()=>[i(B,{class:"main",style:{height:"80vh"}},{default:s(()=>[i(N,null,{default:s(()=>[t(x)?(c(),k(Qe,{key:0,app:t(x)},null,8,["app"])):h("",!0)]),_:1}),e[50]||(e[50]=l()),i(T,null,{default:s(()=>[e[48]||(e[48]=E("br",null,null,-1)),e[49]||(e[49]=l()),i(n,{onClick:e[11]||(e[11]=r=>M.value=!1)},{default:s(()=>[l(d(t(a)["schema.designer.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])]),_:1})}}});export{ol as default};

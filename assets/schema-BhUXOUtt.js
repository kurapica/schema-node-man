import{d as Ne,r as h,L as c,M as xe,N as $e,c as C,e as p,w as s,h as r,i as a,m as Be,j as t,O as ne,f as g,Q as U,R as G,S as Ue,t as m,k as n,F as x,V as Ae,x as Te,W as De,n as $,X as Oe,Y as F,Z as se,$ as Re,a0 as je,a1 as Fe,a2 as Je,a3 as Le,y as Pe,p as w,g as oe,T as re,a4 as I,a5 as ie,a6 as Y,a7 as K,a8 as ue,a9 as ze,aa as Me,ab as de,ac as He,ad as me,ae as pe,af as We,ag as Ye}from"./index-CP9KRlhr.js";/* empty css                    */import{_ as Ze}from"./tryit.vue_vue_type_script_setup_true_lang-CjZVsbDe.js";const qe={key:1},Ge={class:"draw-view"},_e=Ne({__name:"schema",setup(Ie){const Q=h([]),J={[c.Namespace]:1,[c.Scalar]:2,[c.Enum]:3,[c.Struct]:4,[c.Array]:5,[c.Function]:6,[c.Json]:7},ye=[c.Struct,c.Array],u=xe({namespace:"",type:null,keyword:""});if(localStorage.schema_man_search)try{const l=JSON.parse(localStorage.schema_man_search);l&&typeof l=="object"&&(u.namespace=l.namespace||"",u.type=l.type||null,u.keyword=l.keyword||"")}catch(l){}const fe=()=>{re(u.keyword)?re(u.type)?u.namespace="":u.type=null:u.keyword=""},ve=()=>{const l=u.namespace.split(".");u.namespace=l.slice(0,l.length-1).join(".")},ce=l=>{u.namespace=l.name},L=async()=>{localStorage.schema_man_search=JSON.stringify(u);const l=await ie(u.namespace||"");if((l==null?void 0:l.type)===c.Namespace){let e=[...l.schemas||[]];u.type&&(e=e.filter(o=>o.type===u.type)),u.keyword&&(e=e.filter(o=>o.name.match(u.keyword)||o.display&&"".concat(o.display).match(u.keyword))),e.sort((o,y)=>J[o.type]<J[y.type]?-1:J[o.type]<J[y.type]?1:o.name<y.name?-1:1),Q.value=e}};$e(u,L,{immediate:!0});const X=h(),b=h(!1),d=h(void 0),A=h(""),P=h(!1);let V=null;const ge=async()=>{localStorage.schema_new_namespace=u.namespace,d.value=new I({type:"schema.namespacedefine"},{}),b.value=!0,V=d.value.subscribe(()=>{var l,e;A.value=n.value["schema.designer.new"]+" "+(n.value((l=d.value)==null?void 0:l.data.display)||((e=d.value)==null?void 0:e.data.name)||"")},!0)},E=h(null),_=async(l,e)=>{var y,f;E.value=l;const o=await ie(l.name);d.value=new I({type:"schema.namespacedefine",readonly:e},Y(o)),b.value=!0,e?A.value=n.value["schema.designer.view"]+" "+(n.value((y=d.value)==null?void 0:y.data.display)||((f=d.value)==null?void 0:f.data.name)||""):V=d.value.subscribe(()=>{var v,k;A.value=n.value["schema.designer.edit"]+" "+(n.value((v=d.value)==null?void 0:v.data.display)||((k=d.value)==null?void 0:k.data.name)||"")},!0)},we=async l=>{if(!se(l.name)){K.error(n.value["schema.designer.cantdelschema"]);return}if((l.loadState||0)&F.Server){const e=ue();if(e&&!await e.deleteSchema(l.name)){K.error(n.value["schema.designer.error"]);return}}return ze(l.name),Me(l.name),L()},ke=async()=>{var y,f,v;if(!await((y=X.value)==null?void 0:y.validate())||!((f=d.value)!=null&&f.valid)||!((v=d.value)!=null&&v.valid))return;const e=de(Y(He(d.value.data))),o=me(e.name);if(!o||(o.loadState||0)&F.Server){const k=ue();if(k){if(!await k.saveSchema(e)){K.error(n.value["schema.designer.error"]);return}e.loadState=(e.loadState||0)|F.Server}}return pe([e],e.loadState),We(e),Z(),b.value=!1,L()},Z=()=>{var l;V&&V(),(l=d.value)==null||l.dispose(),d.value=void 0,V=null,E.value=null},z=h(!1),ee=h(""),he=()=>{var l;ee.value=(l=d.value)==null?void 0:l.rawData.name,z.value=!0},be=async()=>{var o;const l=Y((o=d.value)==null?void 0:o.rawData);if(!l)return;Z(),b.value=!1,await new Promise(y=>setTimeout(y,200));const e="".concat(l.name,"_copy");l.name="",localStorage.schema_new_namespace=u.namespace,d.value=new I({type:"schema.namespacedefine"},Y(l)),d.value.getField("name").data=e,V&&V(),V=d.value.subscribe(()=>{var y,f;A.value=n.value["schema.designer.new"]+" "+(n.value((y=d.value)==null?void 0:y.data.display)||((f=d.value)==null?void 0:f.data.name)||"")},!0),b.value=!0},T=h(!1);let B=[];const Se=()=>{B=[],T.value=!0},Ce=l=>{B=l.map(e=>e.name)},Ve=()=>{if(!B.length)return;const l=B.length>1?"schema.json":"".concat(B[0],".json"),e=JSON.stringify(B.map(me).map(v=>de(v)).filter(v=>{var k;return v.type!==c.Namespace||((k=v.schemas)==null?void 0:k.length)}),null,2),o=new Blob([e],{type:"application/octet-stream"}),y=URL.createObjectURL(o),f=document.createElement("a");f.href=y,f.download=l,document.body.appendChild(f),f.click(),document.body.removeChild(f),T.value=!1},Ee=l=>(l.text().then(e=>{const o=JSON.parse(e);if(Array.isArray(o))return pe(o,F.Custom),Ye(),L()}),!1);return(l,e)=>{const o=Ue,y=Ae,f=Be,v=Oe,k=Re,ae=De,M=Te,H=Fe,W=Pe,q=Le;return p(),C(W,{class:"main"},{default:s(()=>{var te,le;return[r(f,{style:{height:"fit-content",width:"100%"}},{default:s(()=>[r(t(ne),{model:u,style:{display:"flex"},"hide-required-asterisk":"",inline:""},{default:s(()=>[r(t(U),{modelValue:u.namespace,"onUpdate:modelValue":e[0]||(e[0]=i=>u.namespace=i),"in-form":"",config:{type:"schema.namespace",display:t(G)("schema.namespace")}},null,8,["modelValue","config"]),e[14]||(e[14]=a()),r(t(U),{modelValue:u.type,"onUpdate:modelValue":e[1]||(e[1]=i=>u.type=i),"in-form":"",config:{type:"schema.schematype",display:t(G)("schema.schematype")}},null,8,["modelValue","config"]),e[15]||(e[15]=a()),r(t(U),{modelValue:u.keyword,"onUpdate:modelValue":e[2]||(e[2]=i=>u.keyword=i),"in-form":"",config:{type:"system.string",display:t(G)("schema.designer.keyword")}},null,8,["modelValue","config"]),e[16]||(e[16]=a()),r(o,{type:"info",onClick:fe},{default:s(()=>[a(m(t(n)["schema.designer.reset"]),1)]),_:1}),e[17]||(e[17]=a()),r(o,{type:"primary",onClick:ge},{default:s(()=>[a(m(t(n)["schema.designer.new"]),1)]),_:1}),e[18]||(e[18]=a()),T.value?(p(),g(x,{key:1},[r(o,{type:"success",onClick:Ve},{default:s(()=>[a(m(t(n)["schema.designer.confirm"]),1)]),_:1}),e[13]||(e[13]=a()),r(o,{type:"info",onClick:e[3]||(e[3]=i=>T.value=!1)},{default:s(()=>[a(m(t(n)["schema.designer.cancel"]),1)]),_:1})],64)):(p(),g(x,{key:0},[r(o,{type:"success",onClick:Se},{default:s(()=>[a(m(t(n)["schema.designer.download"]),1)]),_:1}),e[12]||(e[12]=a()),r(y,{style:{"padding-left":"1rem"},"before-upload":Ee,limit:1,"show-file-list":!1},{default:s(()=>[r(o,{type:"success"},{default:s(()=>[a(m(t(n)["schema.designer.upload"]),1)]),_:1})]),_:1})],64))]),_:1},8,["model"])]),_:1}),e[48]||(e[48]=a()),r(M,null,{default:s(()=>[r(ae,{data:Q.value,style:{width:"100%",height:"70vh"},border:!0,"header-align":"left","header-cell-style":{background:"#eee"},onSelectionChange:Ce},{default:s(()=>[T.value?(p(),C(v,{key:0,type:"selection",width:"55"})):$("",!0),e[22]||(e[22]=a()),r(v,{align:"left",prop:"name",label:t(n)["schema.designer.name"],"min-width":"120"},null,8,["label"]),e[23]||(e[23]=a()),r(v,{align:"left",prop:"display",label:t(n)["schema.designer.display"],"min-width":"150"},{default:s(i=>[a(m(t(n)(i.row.display)),1)]),_:1},8,["label"]),e[24]||(e[24]=a()),r(v,{align:"center",prop:"type",label:t(n)["schema.designer.type"],width:"150"},{default:s(i=>[a(m(t(n)["schema.schematype."+i.row.type]),1)]),_:1},8,["label"]),e[25]||(e[25]=a()),r(v,{align:"left","header-align":"center",label:t(n)["schema.designer.oper"],width:"280"},{header:s(()=>[u.namespace?(p(),g("a",{key:0,href:"javascript:void(0)",onClick:ve,style:{"text-decoration":"underline",color:"lightseagreen"}},m(t(n)["schema.designer.return"]),1)):(p(),g("span",qe,m(t(n)["schema.designer.oper"]),1))]),default:s(i=>{var N;return[i.row.type===t(c).Namespace?(p(),C(o,{key:0,type:i.row.hasSchemas||(N=i.row.schemas)!=null&&N.length?"success":"info",onClick:S=>ce(i.row)},{default:s(()=>[a(m(t(n)["schema.designer.down"]),1)]),_:2},1032,["type","onClick"])):(p(),C(o,{key:1,type:"success",onClick:S=>_(i.row,!0)},{default:s(()=>[a(m(t(n)["schema.designer.view"]),1)]),_:2},1032,["onClick"])),e[19]||(e[19]=a()),(i.row.loadState||0)&t(F).System?$("",!0):(p(),C(o,{key:2,type:"warning",onClick:S=>_(i.row,!1)},{default:s(()=>[a(m(t(n)["schema.designer.edit"]),1)]),_:2},1032,["onClick"])),e[20]||(e[20]=a()),t(se)(i.row.name)?(p(),C(k,{key:3,title:t(n)["schema.designer.confirmdelete"],"confirm-button-text":t(n).YES,"cancel-button-text":t(n).NO,icon:t(je),onConfirm:S=>we(i.row)},{reference:s(()=>[r(o,{type:"danger"},{default:s(()=>[a(m(t(n)["schema.designer.delete"]),1)]),_:1})]),_:2},1032,["title","confirm-button-text","cancel-button-text","icon","onConfirm"])):$("",!0)]}),_:1},8,["label"])]),_:1},8,["data"])]),_:1}),e[49]||(e[49]=a()),r(H,null,{default:s(()=>[r(o,{type:"danger",onClick:t(Je),style:{position:"absolute",right:"3rem"}},{default:s(()=>[a(m(t(n)["schema.designer.clearcustomschemas"]),1)]),_:1},8,["onClick"])]),_:1}),e[50]||(e[50]=a()),r(q,{modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=i=>b.value=i),title:A.value,direction:"rtl",size:"100%","append-to-body":"",onClosed:Z},{default:s(()=>[r(W,{class:"main",style:{height:"80vh"}},{default:s(()=>[r(M,null,{default:s(()=>[d.value?(p(),C(t(ne),{key:0,ref_key:"editorRef",ref:X,model:d.value.rawData,"label-width":"160","label-position":"left",style:{width:"100%",height:"90%"}},{default:s(()=>[w("div",Ge,[r(t(U),{node:d.value,"in-form":"expandall","plain-text":"left"},null,8,["node"])])]),_:1},8,["model"])):$("",!0)]),_:1}),e[32]||(e[32]=a()),r(H,null,{default:s(()=>{var i,N,S,D,O;return[e[30]||(e[30]=w("br",null,null,-1)),e[31]||(e[31]=a()),(i=d.value)!=null&&i.readonly?(p(),g(x,{key:0},[ye.includes(d.value.rawData.type)?(p(),C(o,{key:0,type:"primary",onClick:he},{default:s(()=>[a(m(t(n)["schema.designer.tryit"]),1)]),_:1})):$("",!0),e[26]||(e[26]=a()),r(o,{onClick:e[4]||(e[4]=R=>b.value=!1)},{default:s(()=>[a(m(t(n)["schema.designer.close"]),1)]),_:1}),e[27]||(e[27]=a()),(S=(N=E.value)==null?void 0:N.usedBy)!=null&&S.length||(O=(D=E.value)==null?void 0:D.usedByApp)!=null&&O.length?(p(),C(o,{key:1,onClick:e[5]||(e[5]=R=>P.value=!0),style:{float:"right"},type:"info"},{default:s(()=>[a(m(t(n)["schema.designer.viewref"]),1)]),_:1})):$("",!0),e[28]||(e[28]=a()),r(o,{type:"warning",onClick:be},{default:s(()=>[a(m(t(n)["schema.designer.copyschema"]),1)]),_:1})],64)):(p(),g(x,{key:1},[r(o,{type:"primary",onClick:ke},{default:s(()=>[a(m(t(n)["schema.designer.save"]),1)]),_:1}),e[29]||(e[29]=a()),r(o,{onClick:e[6]||(e[6]=R=>b.value=!1)},{default:s(()=>[a(m(t(n)["schema.designer.cancel"]),1)]),_:1})],64))]}),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[51]||(e[51]=a()),r(q,{modelValue:z.value,"onUpdate:modelValue":e[9]||(e[9]=i=>z.value=i),title:t(n)["schema.nav.tryit"]+" - "+(t(n)((te=d.value)==null?void 0:te.data.display)||((le=d.value)==null?void 0:le.data.name)),direction:"rtl",size:"100%","append-to-body":""},{default:s(()=>[r(W,{class:"main",style:{height:"80vh"}},{default:s(()=>[r(M,null,{default:s(()=>[r(Ze,{type:ee.value},null,8,["type"])]),_:1}),e[35]||(e[35]=a()),r(H,null,{default:s(()=>[e[33]||(e[33]=w("br",null,null,-1)),e[34]||(e[34]=a()),r(o,{onClick:e[8]||(e[8]=i=>z.value=!1)},{default:s(()=>[a(m(t(n)["schema.designer.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[52]||(e[52]=a()),r(q,{modelValue:P.value,"onUpdate:modelValue":e[11]||(e[11]=i=>P.value=i),title:t(n)["schema.designer.viewref"],direction:"rtl",size:"40%","append-to-body":""},{default:s(()=>[r(W,{class:"main",style:{height:"80vh"}},{default:s(()=>[r(M,null,{default:s(()=>{var i,N,S,D,O,R;return[(N=(i=E.value)==null?void 0:i.usedBy)!=null&&N.length?(p(),g(x,{key:0},[w("h3",null,m(t(n)["schema.schematype"]),1),e[36]||(e[36]=a()),e[37]||(e[37]=w("hr",null,null,-1)),e[38]||(e[38]=a()),w("ul",null,[(p(!0),g(x,null,oe((S=E.value)==null?void 0:S.usedBy,j=>(p(),g("li",{key:j},[r(t(U),{config:{type:"schema.anytype",readonly:!0},value:j,"plain-text":"left"},null,8,["value"])]))),128))]),e[39]||(e[39]=a()),e[40]||(e[40]=w("br",null,null,-1))],64)):$("",!0),e[44]||(e[44]=a()),(O=(D=E.value)==null?void 0:D.usedByApp)!=null&&O.length?(p(),g(x,{key:1},[w("h3",null,m(t(n)["schema.app.apptarget.app"]),1),e[41]||(e[41]=a()),e[42]||(e[42]=w("hr",null,null,-1)),e[43]||(e[43]=a()),w("ul",null,[(p(!0),g(x,null,oe((R=E.value)==null?void 0:R.usedByApp,j=>(p(),g("li",{key:j},[r(t(U),{config:{type:"schema.app.srcapp",readonly:!0},value:j,"plain-text":"left"},null,8,["value"])]))),128))])],64)):$("",!0)]}),_:1}),e[47]||(e[47]=a()),r(H,null,{default:s(()=>[e[45]||(e[45]=w("br",null,null,-1)),e[46]||(e[46]=a()),r(o,{onClick:e[10]||(e[10]=i=>P.value=!1)},{default:s(()=>[a(m(t(n)["schema.designer.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])]}),_:1})}}});export{_e as default};

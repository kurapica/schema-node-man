import{d as Ne,r as b,L as w,M as $e,O as xe,c as V,e as f,w as o,h as r,i as t,l as Be,j as a,P as ne,f as c,X as T,Q as W,R as Te,t as m,T as n,F as $,S as Ue,v as Ae,U as De,m as x,V as Oe,Y as F,Z as oe,$ as Re,a0 as je,a1 as Fe,a2 as Je,a3 as ze,x as Le,n as g,g as se,N as re,a4 as Z,a5 as ie,a6 as Q,a7 as G,a8 as ue,a9 as Pe,aa as Me,ab as de,ac as Ye,ad as me,ae as fe,af as He,ag as Qe}from"./index-xs_R-iA6.js";/* empty css                    */import{_ as Xe}from"./tryit.vue_vue_type_script_setup_true_lang-OGlvhDsO.js";const qe={key:1},We={class:"draw-view"},_e=Ne({__name:"schema",setup(Ze){const I=b([]),J={[w.Namespace]:1,[w.Scalar]:2,[w.Enum]:3,[w.Struct]:4,[w.Array]:5,[w.Func]:6,[w.Json]:7},pe=[w.Struct,w.Array],u=$e({namespace:"",type:null,keyword:""});if(localStorage.schema_man_search)try{const l=JSON.parse(localStorage.schema_man_search);l&&typeof l=="object"&&(u.namespace=l.namespace||"",u.type=l.type||null,u.keyword=l.keyword||"")}catch(l){}const ye=()=>{re(u.keyword)?re(u.type)?u.namespace="":u.type=null:u.keyword=""},ve=()=>{const l=u.namespace.split(".");u.namespace=l.slice(0,l.length-1).join(".")},we=l=>{u.namespace=l.name},z=async()=>{localStorage.schema_man_search=JSON.stringify(u);const l=await ie(u.namespace||"");if((l==null?void 0:l.type)===w.Namespace){let e=[...l.schemas||[]];u.type&&(e=e.filter(s=>s.type===u.type)),u.keyword&&(e=e.filter(s=>s.name.match(u.keyword)||s.display&&"".concat(s.display).match(u.keyword))),e.sort((s,p)=>J[s.type]<J[p.type]?-1:J[s.type]<J[p.type]?1:s.name<p.name?-1:1),I.value=e}};xe(u,z,{immediate:!0});const K=b(),S=b(!1),d=b(void 0),U=b(""),L=b(!1);let h=null;const ce=async()=>{localStorage.schema_new_namespace=u.namespace,d.value=new Z({type:"system.schema.nodeschema"},{}),S.value=!0,h=d.value.subscribe(()=>{var l,e;U.value=n.value["frontend.view.new"]+" "+(n.value((l=d.value)==null?void 0:l.data.display)||((e=d.value)==null?void 0:e.data.name)||"")},!0)},E=b(null),_=async(l,e)=>{var p,y;E.value=l;const s=await ie(l.name);d.value=new Z({type:"system.schema.nodeschema",readonly:e},Q(s)),S.value=!0,e?U.value=n.value["frontend.view.view"]+" "+(n.value((p=d.value)==null?void 0:p.data.display)||((y=d.value)==null?void 0:y.data.name)||""):h=d.value.subscribe(()=>{var v,k;U.value=n.value["frontend.view.edit"]+" "+(n.value((v=d.value)==null?void 0:v.data.display)||((k=d.value)==null?void 0:k.data.name)||"")},!0)},ge=async l=>{if(!oe(l.name)){G.error(n.value["frontend.view.cantdelschema"]);return}if((l.loadState||0)&F.Server){const e=ue();if(e&&!await e.deleteSchema(l.name)){G.error(n.value["frontend.view.error"]);return}}return Pe(l.name),Me(l.name),z()},ke=async()=>{var p,y,v;if(!await((p=K.value)==null?void 0:p.validate())||!((y=d.value)!=null&&y.valid)||!((v=d.value)!=null&&v.valid))return;const e=de(Q(Ye(d.value.data))),s=me(e.name);if(!s||(s.loadState||0)&F.Server){const k=ue();if(k){if(!await k.saveSchema(e)){G.error(n.value["frontend.view.error"]);return}e.loadState=(e.loadState||0)|F.Server}}return fe([e],e.loadState),He(e),X(),S.value=!1,z()},X=()=>{var l;h&&h(),(l=d.value)==null||l.dispose(),d.value=void 0,h=null,E.value=null},P=b(!1),ee=b(""),be=()=>{var l;ee.value=(l=d.value)==null?void 0:l.rawData.name,P.value=!0},Se=async()=>{var s;const l=Q((s=d.value)==null?void 0:s.rawData);if(!l)return;X(),S.value=!1,await new Promise(p=>setTimeout(p,200));const e="".concat(l.name,"_copy");l.name="",localStorage.schema_new_namespace=u.namespace,d.value=new Z({type:"system.schema.nodeschema"},Q(l)),d.value.getField("name").data=e,h&&h(),h=d.value.subscribe(()=>{var p,y;U.value=n.value["frontend.view.new"]+" "+(n.value((p=d.value)==null?void 0:p.data.display)||((y=d.value)==null?void 0:y.data.name)||"")},!0),S.value=!0},A=b(!1);let B=[];const Ce=()=>{B=[],A.value=!0},Ve=l=>{B=l.map(e=>e.name)},he=()=>{if(!B.length)return;const l=B.length>1?"system.schema.json":"".concat(B[0],".json"),e=JSON.stringify(B.map(me).map(v=>de(v)).filter(v=>{var k;return v.type!==w.Namespace||((k=v.schemas)==null?void 0:k.length)}),null,2),s=new Blob([e],{type:"application/octet-stream"}),p=URL.createObjectURL(s),y=document.createElement("a");y.href=p,y.download=l,document.body.appendChild(y),y.click(),document.body.removeChild(y),A.value=!1},Ee=l=>(l.text().then(e=>{const s=JSON.parse(e);if(Array.isArray(s))return fe(s,F.Custom),Qe(),z()}),!1);return(l,e)=>{const s=Te,p=Ue,y=Be,v=Oe,k=Re,te=De,M=Ae,Y=Fe,H=Le,q=ze;return f(),V(H,{class:"main"},{default:o(()=>{var ae,le;return[r(y,{style:{height:"fit-content",width:"100%"}},{default:o(()=>[r(a(ne),{model:u,style:{display:"flex"},"hide-required-asterisk":"",inline:""},{default:o(()=>[r(a(T),{modelValue:u.namespace,"onUpdate:modelValue":e[0]||(e[0]=i=>u.namespace=i),"in-form":"",config:{type:"system.schema.namespace",display:a(W)("system.schema.namespace")}},null,8,["modelValue","config"]),e[14]||(e[14]=t()),r(a(T),{modelValue:u.type,"onUpdate:modelValue":e[1]||(e[1]=i=>u.type=i),"in-form":"",config:{type:"system.schema.schematype",display:a(W)("system.schema.schematype")}},null,8,["modelValue","config"]),e[15]||(e[15]=t()),r(a(T),{modelValue:u.keyword,"onUpdate:modelValue":e[2]||(e[2]=i=>u.keyword=i),"in-form":"",config:{type:"system.string",display:a(W)("frontend.view.keyword")}},null,8,["modelValue","config"]),e[16]||(e[16]=t()),r(s,{type:"info",onClick:ye},{default:o(()=>[t(m(a(n)["frontend.view.reset"]),1)]),_:1}),e[17]||(e[17]=t()),r(s,{type:"primary",onClick:ce},{default:o(()=>[t(m(a(n)["frontend.view.new"]),1)]),_:1}),e[18]||(e[18]=t()),A.value?(f(),c($,{key:1},[r(s,{type:"success",onClick:he},{default:o(()=>[t(m(a(n)["frontend.view.confirm"]),1)]),_:1}),e[13]||(e[13]=t()),r(s,{type:"info",onClick:e[3]||(e[3]=i=>A.value=!1)},{default:o(()=>[t(m(a(n)["frontend.view.cancel"]),1)]),_:1})],64)):(f(),c($,{key:0},[r(s,{type:"success",onClick:Ce},{default:o(()=>[t(m(a(n)["frontend.view.download"]),1)]),_:1}),e[12]||(e[12]=t()),r(p,{style:{"padding-left":"1rem"},"before-upload":Ee,limit:1,"show-file-list":!1},{default:o(()=>[r(s,{type:"success"},{default:o(()=>[t(m(a(n)["frontend.view.upload"]),1)]),_:1})]),_:1})],64))]),_:1},8,["model"])]),_:1}),e[48]||(e[48]=t()),r(M,null,{default:o(()=>[r(te,{data:I.value,style:{width:"100%",height:"70vh"},border:!0,"header-align":"left","header-cell-style":{background:"#eee"},onSelectionChange:Ve},{default:o(()=>[A.value?(f(),V(v,{key:0,type:"selection",width:"55"})):x("",!0),e[22]||(e[22]=t()),r(v,{align:"left",prop:"name",label:a(n)["frontend.view.name"],"min-width":"120"},null,8,["label"]),e[23]||(e[23]=t()),r(v,{align:"left",prop:"display",label:a(n)["frontend.view.display"],"min-width":"150"},{default:o(i=>[t(m(a(n)(i.row.display.key?i.row.display:i.row.name)),1)]),_:1},8,["label"]),e[24]||(e[24]=t()),r(v,{align:"center",prop:"type",label:a(n)["frontend.view.type"],width:"150"},{default:o(i=>[t(m(a(n)["system.schema.schematype."+i.row.type]),1)]),_:1},8,["label"]),e[25]||(e[25]=t()),r(v,{align:"left","header-align":"center",label:a(n)["frontend.view.oper"],width:"280"},{header:o(()=>[u.namespace?(f(),c("a",{key:0,href:"javascript:void(0)",onClick:ve,style:{"text-decoration":"underline",color:"lightseagreen"}},m(a(n)["frontend.view.return"]),1)):(f(),c("span",qe,m(a(n)["frontend.view.oper"]),1))]),default:o(i=>{var N;return[i.row.type===a(w).Namespace?(f(),V(s,{key:0,type:i.row.hasSchemas||(N=i.row.schemas)!=null&&N.length?"success":"info",onClick:C=>we(i.row)},{default:o(()=>[t(m(a(n)["frontend.view.down"]),1)]),_:2},1032,["type","onClick"])):(f(),V(s,{key:1,type:"success",onClick:C=>_(i.row,!0)},{default:o(()=>[t(m(a(n)["frontend.view.view"]),1)]),_:2},1032,["onClick"])),e[19]||(e[19]=t()),(i.row.loadState||0)&a(F).System?x("",!0):(f(),V(s,{key:2,type:"warning",onClick:C=>_(i.row,!1)},{default:o(()=>[t(m(a(n)["frontend.view.edit"]),1)]),_:2},1032,["onClick"])),e[20]||(e[20]=t()),a(oe)(i.row.name)?(f(),V(k,{key:3,title:a(n)["frontend.view.confirmdelete"],"confirm-button-text":a(n).YES,"cancel-button-text":a(n).NO,icon:a(je),onConfirm:C=>ge(i.row)},{reference:o(()=>[r(s,{type:"danger"},{default:o(()=>[t(m(a(n)["frontend.view.delete"]),1)]),_:1})]),_:2},1032,["title","confirm-button-text","cancel-button-text","icon","onConfirm"])):x("",!0)]}),_:1},8,["label"])]),_:1},8,["data"])]),_:1}),e[49]||(e[49]=t()),r(Y,null,{default:o(()=>[r(s,{type:"danger",onClick:a(Je),style:{position:"absolute",right:"3rem"}},{default:o(()=>[t(m(a(n)["frontend.view.clearcustomschemas"]),1)]),_:1},8,["onClick"])]),_:1}),e[50]||(e[50]=t()),r(q,{modelValue:S.value,"onUpdate:modelValue":e[7]||(e[7]=i=>S.value=i),title:U.value,direction:"rtl",size:"100%","append-to-body":"",onClosed:X},{default:o(()=>[r(H,{class:"main",style:{height:"80vh"}},{default:o(()=>[r(M,null,{default:o(()=>[d.value?(f(),V(a(ne),{key:0,ref_key:"editorRef",ref:K,model:d.value.rawData,"label-width":"160","label-position":"left",style:{width:"100%",height:"90%"}},{default:o(()=>[g("div",We,[r(a(T),{node:d.value,"in-form":"expandall","plain-text":"left"},null,8,["node"])])]),_:1},8,["model"])):x("",!0)]),_:1}),e[32]||(e[32]=t()),r(Y,null,{default:o(()=>{var i,N,C,D,O;return[e[30]||(e[30]=g("br",null,null,-1)),e[31]||(e[31]=t()),(i=d.value)!=null&&i.readonly?(f(),c($,{key:0},[pe.includes(d.value.rawData.type)?(f(),V(s,{key:0,type:"primary",onClick:be},{default:o(()=>[t(m(a(n)["frontend.view.tryit"]),1)]),_:1})):x("",!0),e[26]||(e[26]=t()),r(s,{onClick:e[4]||(e[4]=R=>S.value=!1)},{default:o(()=>[t(m(a(n)["frontend.view.close"]),1)]),_:1}),e[27]||(e[27]=t()),(C=(N=E.value)==null?void 0:N.usedBy)!=null&&C.length||(O=(D=E.value)==null?void 0:D.usedByApp)!=null&&O.length?(f(),V(s,{key:1,onClick:e[5]||(e[5]=R=>L.value=!0),style:{float:"right"},type:"info"},{default:o(()=>[t(m(a(n)["frontend.view.viewref"]),1)]),_:1})):x("",!0),e[28]||(e[28]=t()),r(s,{type:"warning",onClick:Se},{default:o(()=>[t(m(a(n)["frontend.view.copyschema"]),1)]),_:1})],64)):(f(),c($,{key:1},[r(s,{type:"primary",onClick:ke},{default:o(()=>[t(m(a(n)["frontend.view.save"]),1)]),_:1}),e[29]||(e[29]=t()),r(s,{onClick:e[6]||(e[6]=R=>S.value=!1)},{default:o(()=>[t(m(a(n)["frontend.view.cancel"]),1)]),_:1})],64))]}),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[51]||(e[51]=t()),r(q,{modelValue:P.value,"onUpdate:modelValue":e[9]||(e[9]=i=>P.value=i),title:a(n)["frontend.nav.tryit"]+" - "+(a(n)((ae=d.value)==null?void 0:ae.data.display)||((le=d.value)==null?void 0:le.data.name)),direction:"rtl",size:"100%","append-to-body":""},{default:o(()=>[r(H,{class:"main",style:{height:"80vh"}},{default:o(()=>[r(M,null,{default:o(()=>[r(Xe,{type:ee.value},null,8,["type"])]),_:1}),e[35]||(e[35]=t()),r(Y,null,{default:o(()=>[e[33]||(e[33]=g("br",null,null,-1)),e[34]||(e[34]=t()),r(s,{onClick:e[8]||(e[8]=i=>P.value=!1)},{default:o(()=>[t(m(a(n)["frontend.view.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[52]||(e[52]=t()),r(q,{modelValue:L.value,"onUpdate:modelValue":e[11]||(e[11]=i=>L.value=i),title:a(n)["frontend.view.viewref"],direction:"rtl",size:"40%","append-to-body":""},{default:o(()=>[r(H,{class:"main",style:{height:"80vh"}},{default:o(()=>[r(M,null,{default:o(()=>{var i,N,C,D,O,R;return[(N=(i=E.value)==null?void 0:i.usedBy)!=null&&N.length?(f(),c($,{key:0},[g("h3",null,m(a(n)["system.schema.schematype"]),1),e[36]||(e[36]=t()),e[37]||(e[37]=g("hr",null,null,-1)),e[38]||(e[38]=t()),g("ul",null,[(f(!0),c($,null,se((C=E.value)==null?void 0:C.usedBy,j=>(f(),c("li",{key:j},[r(a(T),{config:{type:"system.schema.anytype",readonly:!0},value:j,"plain-text":"left"},null,8,["value"])]))),128))]),e[39]||(e[39]=t()),e[40]||(e[40]=g("br",null,null,-1))],64)):x("",!0),e[44]||(e[44]=t()),(O=(D=E.value)==null?void 0:D.usedByApp)!=null&&O.length?(f(),c($,{key:1},[g("h3",null,m(a(n)["system.schema.apptarget.app"]),1),e[41]||(e[41]=t()),e[42]||(e[42]=g("hr",null,null,-1)),e[43]||(e[43]=t()),g("ul",null,[(f(!0),c($,null,se((R=E.value)==null?void 0:R.usedByApp,j=>(f(),c("li",{key:j},[r(a(T),{config:{type:"system.schema.app",readonly:!0},value:j,"plain-text":"left"},null,8,["value"])]))),128))])],64)):x("",!0)]}),_:1}),e[47]||(e[47]=t()),r(Y,null,{default:o(()=>[e[45]||(e[45]=g("br",null,null,-1)),e[46]||(e[46]=t()),r(s,{onClick:e[10]||(e[10]=i=>L.value=!1)},{default:o(()=>[t(m(a(n)["frontend.view.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])]}),_:1})}}});export{_e as default};

import{d as fe,r as g,J as c,K as ve,L as ge,c as k,e as v,w as n,h as o,i as l,m as ke,j as s,M as Q,f as b,N as A,O as J,P as he,t as p,k as d,F as B,Q as we,q as be,R as Se,C as V,S as Ce,U as E,V as X,W as Ne,X as Ve,Z as Ee,v as _e,n as R,T as Z,$ as G,a0 as I,a1 as Y,a2 as $e,a3 as xe,a4 as Ue,a5 as ee,a6 as ae,a7 as je,a8 as Te,a9 as Ae,aa as S}from"./index-nz2vpaM1.js";import{_ as Be}from"./tryit.vue_vue_type_script_setup_true_lang-TtCkbzAc.js";const De={key:1},Oe={class:"draw-view"},ze=fe({__name:"schema",setup(Fe){const z=g([]),_={[c.Namespace]:1,[c.Scalar]:2,[c.Enum]:3,[c.Struct]:4,[c.Array]:5,[c.Function]:6},te=[c.Struct,c.Array],r=ve({namespace:"",type:null,keyword:""});if(localStorage.schema_man_search)try{const t=JSON.parse(localStorage.schema_man_search);t&&typeof t=="object"&&(r.namespace=t.namespace||"",r.type=t.type||null,r.keyword=t.keyword||"")}catch(t){}const le=()=>{Z(r.keyword)?Z(r.type)?r.namespace="":r.type=null:r.keyword=""},se=()=>{const t=r.namespace.split(".");r.namespace=t.slice(0,t.length-1).join(".")},ne=t=>{r.namespace=t.name},$=async()=>{localStorage.schema_man_search=JSON.stringify(r);const t=await Ae(r.namespace||"");if((t==null?void 0:t.type)===c.Namespace){let e=[...t.schemas||[]];r.type&&(e=e.filter(a=>a.type===r.type)),r.keyword&&(e=e.filter(a=>a.name.match(r.keyword)||a.desc&&"".concat(a.desc).match(r.keyword))),e.sort((a,f)=>_[a.type]<_[f.type]?-1:_[a.type]<_[f.type]?1:a.name<f.name?-1:1),z.value=e}};ge(r,$,{immediate:!0});const H=g(),h=g(!1),u=g(void 0),x=g("");let U=null;const oe=async()=>{localStorage.schema_new_namespace=r.namespace,u.value=new G({type:"schema.namespacedefine"},{}),h.value=!0,U=u.value.subscribe(()=>{var t,e;x.value=d.value["schema.designer.new"]+" "+(((t=u.value)==null?void 0:t.data.desc)||((e=u.value)==null?void 0:e.data.name)||"")},!0)},L=async(t,e)=>{var a,f;u.value=new G({type:"schema.namespacedefine",readonly:e},I(Y(t))),h.value=!0,e?x.value=d.value["schema.designer.view"]+" "+(((a=u.value)==null?void 0:a.data.desc)||((f=u.value)==null?void 0:f.data.name)||""):U=u.value.subscribe(()=>{var m,y;x.value=d.value["schema.designer.edit"]+" "+(((m=u.value)==null?void 0:m.data.desc)||((y=u.value)==null?void 0:y.data.name)||"")},!0)},re=async t=>{if(!X(t.name)){$e.error(d.value["schema.designer.cantdelschema"]);return}return t.loadState&&E.Server,xe(t.name),Ue(t.name),$()},de=async()=>{var f,m,y;if(!await((f=H.value)==null?void 0:f.validate())||!((m=u.value)!=null&&m.valid)||!((y=u.value)!=null&&y.valid))return;const e=I(Y(u.value.data)),a=ee(e.name);return!a||(a.loadState||0)&E.Server,ae([e]),je(e),h.value=!1,$()},ie=()=>{var t;U&&U(),(t=u.value)==null||t.dispose(),u.value=void 0},j=g(!1),M=g(""),ue=()=>{var t;M.value=(t=u.value)==null?void 0:t.rawData.name,j.value=!0},C=g(!1);let w=[];const me=()=>{w=[],C.value=!0},ce=t=>{w=t.map(e=>e.name)},q=t=>{var f;const e=t,a={name:e.name,type:e.type,desc:S(e.desc)};switch(e.type){case c.Namespace:a.schemas=(f=e.schemas)==null?void 0:f.filter(m=>m.type===c.Namespace||!((m.loadState||0)&E.System)).map(q).filter(m=>{var y;return m.type!==c.Namespace||((y=m.schemas)==null?void 0:y.length)});break;case c.Scalar:a.scalar=S(e.scalar,!0);break;case c.Enum:a.enum=S(e.enum,!0);break;case c.Struct:a.struct=S(e.struct,!0);break;case c.Array:a.array=S(e.array,!0);break;case c.Function:a.func={...S(e.func,!0),func:void 0},a.func.exps||(a.func.exps=[]),a.func.args||(a.func.args=[]);break}return a},pe=()=>{if(!w.length)return;const t=w.length>1?"schema.json":"".concat(w[0],".json"),e=JSON.stringify(w.map(ee).map(q).filter(y=>{var T;return y.type!==c.Namespace||((T=y.schemas)==null?void 0:T.length)}),null,2),a=new Blob([e],{type:"application/octet-stream"}),f=URL.createObjectURL(a),m=document.createElement("a");m.href=f,m.download=t,document.body.appendChild(m),m.click(),document.body.removeChild(m),C.value=!1},ye=t=>(t.text().then(e=>{const a=JSON.parse(e);if(Array.isArray(a))return ae(a,E.Custom),Te(),$()}),!1);return(t,e)=>{const a=he,f=we,m=ke,y=Ce,T=Se,D=be,O=Ne,F=_e,W=Ee;return v(),k(F,{class:"main"},{default:n(()=>{var K,P;return[o(m,{style:{height:"fit-content",width:"100%"}},{default:n(()=>[o(s(Q),{model:r,style:{display:"flex"},"hide-required-asterisk":"",inline:""},{default:n(()=>[o(s(A),{modelValue:r.namespace,"onUpdate:modelValue":e[0]||(e[0]=i=>r.namespace=i),"in-form":"",config:{type:"schema.namespace",display:s(J)("schema.namespace")}},null,8,["modelValue","config"]),e[11]||(e[11]=l()),o(s(A),{modelValue:r.type,"onUpdate:modelValue":e[1]||(e[1]=i=>r.type=i),"in-form":"",config:{type:"schema.schematype",display:s(J)("schema.schematype")}},null,8,["modelValue","config"]),e[12]||(e[12]=l()),o(s(A),{modelValue:r.keyword,"onUpdate:modelValue":e[2]||(e[2]=i=>r.keyword=i),"in-form":"",config:{type:"system.string",display:s(J)("schema.designer.keyword")}},null,8,["modelValue","config"]),e[13]||(e[13]=l()),o(a,{type:"info",onClick:le},{default:n(()=>[l(p(s(d)["schema.designer.reset"]),1)]),_:1}),e[14]||(e[14]=l()),o(a,{type:"primary",onClick:oe},{default:n(()=>[l(p(s(d)["schema.designer.new"]),1)]),_:1}),e[15]||(e[15]=l()),C.value?(v(),b(B,{key:1},[o(a,{type:"success",onClick:pe},{default:n(()=>[l(p(s(d)["schema.designer.confirm"]),1)]),_:1}),e[10]||(e[10]=l()),o(a,{type:"info",onClick:e[3]||(e[3]=i=>C.value=!1)},{default:n(()=>[l(p(s(d)["schema.designer.cancel"]),1)]),_:1})],64)):(v(),b(B,{key:0},[o(a,{type:"success",onClick:me},{default:n(()=>[l(p(s(d)["schema.designer.download"]),1)]),_:1}),e[9]||(e[9]=l()),o(f,{style:{"padding-left":"1rem"},"before-upload":ye,limit:1,"show-file-list":!1},{default:n(()=>[o(a,{type:"success"},{default:n(()=>[l(p(s(d)["schema.designer.upload"]),1)]),_:1})]),_:1})],64))]),_:1},8,["model"])]),_:1}),e[31]||(e[31]=l()),o(D,null,{default:n(()=>[o(T,{data:z.value,style:{width:"100%",height:"70vh"},border:!0,"header-align":"left","header-cell-style":{background:"#eee"},onSelectionChange:ce},{default:n(()=>[C.value?(v(),k(y,{key:0,type:"selection",width:"55"})):V("",!0),e[19]||(e[19]=l()),o(y,{align:"left",prop:"name",label:s(d)["schema.designer.name"],"min-width":"120"},null,8,["label"]),e[20]||(e[20]=l()),o(y,{align:"left",prop:"desc",label:s(d)["schema.designer.desc"],"min-width":"150"},null,8,["label"]),e[21]||(e[21]=l()),o(y,{align:"center",prop:"type",label:s(d)["schema.designer.type"],width:"150"},{default:n(i=>[l(p(s(d)["schema.schematype."+i.row.type]),1)]),_:1},8,["label"]),e[22]||(e[22]=l()),o(y,{align:"left","header-align":"center",label:s(d)["schema.designer.oper"],width:"280"},{header:n(()=>[r.namespace?(v(),b("a",{key:0,href:"javascript:void(0)",onClick:se,style:{"text-decoration":"underline",color:"lightseagreen"}},p(s(d)["schema.designer.return"]),1)):(v(),b("span",De,p(s(d)["schema.designer.oper"]),1))]),default:n(i=>[i.row.type===s(c).Namespace?(v(),k(a,{key:0,type:"info",onClick:N=>ne(i.row)},{default:n(()=>[l(p(s(d)["schema.designer.down"]),1)]),_:2},1032,["onClick"])):(v(),k(a,{key:1,type:"info",onClick:N=>L(i.row,!0)},{default:n(()=>[l(p(s(d)["schema.designer.view"]),1)]),_:2},1032,["onClick"])),e[16]||(e[16]=l()),(i.row.loadState||0)&s(E).System?V("",!0):(v(),k(a,{key:2,type:"success",onClick:N=>L(i.row,!1)},{default:n(()=>[l(p(s(d)["schema.designer.edit"]),1)]),_:2},1032,["onClick"])),e[17]||(e[17]=l()),s(X)(i.row.name)?(v(),k(a,{key:3,type:"danger",onClick:N=>re(i.row)},{default:n(()=>[l(p(s(d)["schema.designer.delete"]),1)]),_:2},1032,["onClick"])):V("",!0)]),_:1},8,["label"])]),_:1},8,["data"])]),_:1}),e[32]||(e[32]=l()),o(O,null,{default:n(()=>[o(a,{type:"danger",onClick:s(Ve),style:{position:"absolute",right:"3rem"}},{default:n(()=>[l(p(s(d)["schema.designer.clearcustomschemas"]),1)]),_:1},8,["onClick"])]),_:1}),e[33]||(e[33]=l()),o(W,{modelValue:h.value,"onUpdate:modelValue":e[6]||(e[6]=i=>h.value=i),title:x.value,direction:"rtl",size:"100%","destroy-on-close":"","append-to-body":"",onClosed:ie},{default:n(()=>[o(F,{class:"main",style:{height:"80vh"}},{default:n(()=>[o(D,null,{default:n(()=>[u.value?(v(),k(s(Q),{key:0,ref_key:"editorRef",ref:H,model:u.value.rawData,"label-width":"160","label-position":"left",style:{width:"100%",height:"90%"}},{default:n(()=>[R("div",Oe,[o(s(A),{node:u.value,"in-form":"expandall","plain-text":"left"},null,8,["node"])])]),_:1},8,["model"])):V("",!0)]),_:1}),e[27]||(e[27]=l()),o(O,null,{default:n(()=>{var i;return[e[25]||(e[25]=R("br",null,null,-1)),e[26]||(e[26]=l()),(i=u.value)!=null&&i.readonly?(v(),b(B,{key:0},[te.includes(u.value.rawData.type)?(v(),k(a,{key:0,type:"primary",onClick:ue},{default:n(()=>[l(p(s(d)["schema.designer.tryit"]),1)]),_:1})):V("",!0),e[23]||(e[23]=l()),o(a,{onClick:e[4]||(e[4]=N=>h.value=!1)},{default:n(()=>[l(p(s(d)["schema.designer.close"]),1)]),_:1})],64)):(v(),b(B,{key:1},[o(a,{type:"primary",onClick:de},{default:n(()=>[l(p(s(d)["schema.designer.save"]),1)]),_:1}),e[24]||(e[24]=l()),o(a,{onClick:e[5]||(e[5]=N=>h.value=!1)},{default:n(()=>[l(p(s(d)["schema.designer.cancel"]),1)]),_:1})],64))]}),_:1})]),_:1})]),_:1},8,["modelValue","title"]),e[34]||(e[34]=l()),o(W,{modelValue:j.value,"onUpdate:modelValue":e[8]||(e[8]=i=>j.value=i),title:s(d)["schema.nav.tryit"]+(((K=u.value)==null?void 0:K.data.desc)||((P=u.value)==null?void 0:P.data.name)),direction:"rtl",size:"100%","destroy-on-close":"","append-to-body":""},{default:n(()=>[o(F,{class:"main",style:{height:"80vh"}},{default:n(()=>[o(D,null,{default:n(()=>[o(Be,{type:M.value},null,8,["type"])]),_:1}),e[30]||(e[30]=l()),o(O,null,{default:n(()=>[e[28]||(e[28]=R("br",null,null,-1)),e[29]||(e[29]=l()),o(a,{onClick:e[7]||(e[7]=i=>j.value=!1)},{default:n(()=>[l(p(s(d)["schema.designer.close"]),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue","title"])]}),_:1})}}});export{ze as default};
